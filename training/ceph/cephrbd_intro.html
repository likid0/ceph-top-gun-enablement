<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Ceph Top Gun Enablement</title>
    <link rel="canonical" href="https://likid0.github.io/ceph-top-gun-enablement/training/ceph/cephrbd_intro.html">
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.ceph.com/en/latest/" target="_blank">
          <img src="../../_/img/header_logo_reverse.svg" height="48px" alt="Ceph">
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Get Help</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://access.redhat.com/documentation/en-us/red_hat_openshift_container_storage" target="_blank">Ceph Documentation</a>
            <a class="navbar-item" href="https://bugzilla.redhat.com/describecomponents.cgi?product=Red%20Hat%20OpenShift%20Container%20Storage" target="_blank">Browse Bugs</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Improve Guides</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/red-hat-storage/ocs-training/issues/new/choose" target="_blank">Open Issue</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Infos</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://www.redhat.com/en/blog/channel/red-hat-storage" target="_blank">Our Blog</a>
            <a class="navbar-item" href="https://www.youtube.com/channel/UCoyG8VyvB-XUxQl1mD3T3Gw" target="_blank">Youtube</a>
            <a class="navbar-item" href="https://docs.ceph.com/en/latest/" target="_blank">OCS Technology</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="training" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Ceph Top-Gun Enablement</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Lab Setup</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="opentlc_lab_env.html">Opentlc Lab Env</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Core Ceph</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_introduction.html">Ceph Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_architecture.html">Ceph Architecture</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_cluster_partitioning.html">Ceph Cluster Partitioning</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_hardware.html">Ceph Hardware Recommendations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_deployment_intro.html">Ceph Install Methods </a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_cephadm_intro.html">Cephadm Orchestrator</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ceph_deploy_basic.html">Lab. Deploy Ceph with Cephadm</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph RADOS Block Device</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="cephrbd_intro.html">RADOS Block Device introduction</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">CephFS Shared FileSystem</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephfs_intro.html">CephFS introduction &amp; Deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cephfs_advanced.html">CephFS Deep Dive</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph RadosGW</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_intro.html">RGW Introduction &amp; Deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_arch_deep_dive.html">RGW Deep Dive</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_ha.html">RGW High Availability</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_ssl.html">RGW &amp; Ingress with SSL</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_users_quotas.html">RGW Users &amp; Quotas</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_auth.html">RGW Auth &amp; Authz</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_object_versioning.html">RGW S3 Object Versioning</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_placement_and_storage_classes.html">RGW Placement &amp; Storage Classes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_life_cycle_management.html">RGW Life Cycle Management</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_bucket_policy.html">RGW S3 Bucket Policy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_sts_introduction.html">RGW Secure Token Service</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_sts_bucket_role_policy.html">RGW Bucket vs Role Policy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_multisite.html">RGW Multisite Replication</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_cloudsync.html">RGW Object Cloud Transition</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_presignedurl.html">RGW presigned URL</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Troubleshooting</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="trouble-shooting-nearfull-osds.html">Troubleshooting nearfull OSDs</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Stretched</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="rhcs-stretched-deploy.html">Ceph Stretch Mode</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Ceph Top-Gun Enablement</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Ceph Top-Gun Enablement</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Ceph Top-Gun Enablement</a></li>
    <li>Ceph RADOS Block Device</li>
    <li><a href="cephrbd_intro.html">RADOS Block Device introduction</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///antora/training/modules/ceph/pages/cephrbd_intro.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<div class="sect1">
<h2 id="_rados_block_device_rbd"><a class="anchor" href="#_rados_block_device_rbd"></a>RADOS Block Device (RBD)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h3>
<div class="paragraph">
<p>Ceph supports block storage through the RADOS Block Device (aka RBD) access
method for Linux distributions and Kubernetes. RBDs can be accessed either through a kernel module (Linux, Kubernetes)
or through the <code>librbd</code> API (OpenStack, Proxmox). In the Kubernetes world,
RBDs are designed to address the need for RWO PVCs. <code>Pacific</code> provides a
major update to <code>librbd</code> aimed at reducing the performance gap with <code>kRBD</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_details"><a class="anchor" href="#_details"></a>Details</h3>
<div class="paragraph">
<p>Each block device is known as a RBD Image and has a set of characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Image Name - a character string that supports Unicode</p>
</li>
<li>
<p>Image Order - Also known as Image Object Size</p>
</li>
<li>
<p>Image Size - The size of the block device</p>
</li>
<li>
<p>Stripe Unit - To configure <code>librbd</code> striping (defaults to 4MiB)</p>
</li>
<li>
<p>Stripe Count - To configure <code>librbd</code> striping (defaults to 1)</p>
</li>
<li>
<p>Format - To control the image format (defaults to 2)</p>
</li>
<li>
<p>Image features</p>
<div class="ulist">
<ul>
<li>
<p><code>layering</code>: layering support</p>
</li>
<li>
<p><code>striping</code>: striping v2 support</p>
</li>
<li>
<p><code>exclusive-lock</code>: exclusive locking support</p>
</li>
<li>
<p><code>object-map</code>: object map support (requires exclusive-lock)</p>
</li>
<li>
<p><code>fast-diff</code>: fast diff calculations (requires object-map)</p>
</li>
<li>
<p><code>deep-flatten</code>: snapshot flatten support</p>
</li>
<li>
<p><code>journaling</code>: journaled IO support (requires exclusive-lock)</p>
</li>
<li>
<p><code>data-pool</code>: erasure coded pool support</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order to provide the best performance and avoid bottlenecks Ceph Block Devices
are broken down into smaller pieces. Therefor, a single 32MiB RBD Image will be broken
down in as many object as possible, each object conforming to the size configured
for a specific RBD.</p>
</div>
<div class="paragraph">
<p>As a result of this breakdown each object of a given RBD Image will have a different name.
The name of each object is formatted as <code>{rbd_image_id}.{offset}</code>. You can visualize RBD objects
in a Ceph pool using the <code>rados -p {pool_name} ls</code>. As each object is assigned a different
RADOS name, each object will be assigned to a specific Placement Group as described earlier
in the Data Placement chapter.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The cluster sets a default parameter <code>rbd_default_order</code> to a value of <code>22</code>
that configures the RBD Images to use 4MiB objects. This parameter can be set
on a per client basis.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
To avoid unnecessary cluster warning, make sure that a pool that contains RBD
Images is assigend a <code>rbd</code> label. This is easily achieved through the <code>rbd init pool {pool_name}</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The RBD Image order is expressed as an integer between 12 and 25. It is a bit-shift operator and as such
the default <code>22</code> value is for 4MiB objects while <code>21</code> maps to 2MiB and <code>23</code> maps to 8MiB. Since
Red Hat Ceph Storage 4 (Nautilus based) you can specify either the size of the object as an order
(<code>--image-order</code>) or as a pure object size (<code>--object-size</code>).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
All RBD Images are thin provisioned. To reclaim the unused sectors of a RBD Image
you must configure the <code>discard</code> option when mounting the filesystem hosted on the RBD Image
or run the <code>fstrim</code> command at regular intervals.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_accessing_rbd_images"><a class="anchor" href="#_accessing_rbd_images"></a>Accessing RBD Images</h3>
<div class="paragraph">
<p>The kernel RBD driver offers superior performance while not providing the
same level of functionality. e.g., no RBD Mirroring until <code>Pacific</code>.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="_images/cephrbd-krbd-nobg.png" alt="Kernel based RADOS Block Device">
</div>
<div class="title">Figure 1. kRBD Diagram</div>
</div>
<div class="paragraph">
<p>To map a RBD Image using the kernel RBD module, aka <code>krbd</code>, use the <code>rbd map {pool_name}/{image_name}</code>
or the <code>rbd -p {pool_name} {image_name}</code> commands. As a result the RBD Image is mapped as
<code>/dev/rbd{n}</code> on the Linux server where the command is issued. <code>{n}</code> will be <code>0</code> for the
first RBD Image mapped onto the node.</p>
</div>
<div class="paragraph">
<p>To view the RBD Images mapped into a node you can use <code>rbd showmapped</code> or <code>rbd device ls</code> starting
with Red Hat Storage 5 for the latter.</p>
</div>
<div class="paragraph">
<p><sub>~</sub>
[root@node ~]# rbd showmapped
id pool namespace image snap device
0 rbd test - /dev/rbd0
<sub>~</sub></p>
</div>
<div class="paragraph">
<p>Once the RBD Image has been mapped onto the server it is available for regular block device
commands such as <code>mkfs</code>.</p>
</div>
<div class="paragraph">
<p>To unmap a RBD Image from a node use the <code>rbd unmap {rbd_device_name}</code>. e.g. <code>rbd unmap /dev/rbd0</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
A the <code>rbd map</code> and <code>rbd unmap</code> commands manipulate the Linux <code>dev</code> directory content
<code>root</code> privilege is required to issue those commands.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default the cluster is configured to use the pool name <code>rbd</code> to access RBD Images.
The default pool can be modified on a per client machine basis using the <code>rbd_default_pool</code>
parameter. Therefor, if the name of the pool is omitted the <code>rbd</code> command will try to
access the default pool.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong><em>Userspace RBD (librbd)</em></strong></p>
</div>
<div class="paragraph">
<p>This access method leverages all existing RBD features such as RBD Mirroring.</p>
</div>
<div class="imageblock text-center unresolved">
<div class="content">
<img src="cephrbd-librbd-nobg.png" alt="Userspace RADOS Block Device">
</div>
<div class="title">Figure 2. librbd Diagram</div>
</div>
<div class="paragraph">
<p>Because the user space implementation of the Ceph block device (for example, librbd) cannot take
advantage of the Linux page cache, it performs its own in-memory caching, known as
RBD caching. When the OS implements a barrier mechanism or a flush request, Ceph writes all dirty
data to the OSDs. This means that using write-back caching is just as safe as using physical hard
disk caching with a VM that properly sends flushes (for example, Linux kernel &gt;= 2.6.32). The
cache uses a Least Recently Used (LRU) algorithm, and in write-back mode it can coalesce contiguous
requests for better throughput.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The RBD Cache is local to the client that issues the IO request. By default RBD Cache is
enabled on Ceph client machine.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
By default the Cache is enabled in write-back mode but it can be set to write-through mode.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following parameters can be used to control each <code>librbd</code> client caching:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>rbd_cache</code> - <code>true</code> or <code>false</code> (defaults to <code>true</code>)</p>
</li>
<li>
<p><code>rbd_cache_size</code> - Cache size in bytes (defaults to 32MiB per RBD Image)</p>
</li>
<li>
<p><code>rbd_cache_max_dirty</code> - Max dirty bytes (defaults to 24MiB. Set to 0 for write-through mode)</p>
</li>
<li>
<p><code>rbd_cache_target_dirty</code> - Dirty bytes to start preemptive flush (defaults to 16MiB)</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Use the <code>ceph config set {client} {parameter} {value}</code> to change those parameters.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_manipulating"><a class="anchor" href="#_manipulating"></a>Manipulating</h3>
<div class="paragraph">
<p>The <code>rbd</code> command is used to create, modify and in general manipulate RBD Images.
The following table provides a summary of the different RBD commands.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>rbd create</code> - To create a RBD Image</p>
</li>
<li>
<p><code>rbd rm</code> - To delete a RBD Image</p>
</li>
<li>
<p><code>rbd ls</code> - List the RBD Images in a pool</p>
</li>
<li>
<p><code>rbd info</code> - To view RBD Image parameters</p>
</li>
<li>
<p><code>rbd du</code> - To view the space used in a RBD Image</p>
</li>
<li>
<p><code>rbd snap</code> - To create a snapshot of a RBD Image</p>
</li>
<li>
<p><code>rbd clone</code> - To create a clone based on a RBD Image snapshot</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_snapshots"><a class="anchor" href="#_snapshots"></a>Snapshots</h3>
<div class="paragraph">
<p>RBD snapshots are read-only copies of an RBD image created at a particular time. RBD snapshots use
a COW technique to reduce the amount of storage needed to maintain snapshots. Before applying a
write I/O request to an RBD snapshot image, the cluster copies the original data to another area
in the placement group of the object affected by the I/O operation. Snapshots do not consume any
storage space when created, but grow in size as the objects that they contain change. RBD images
support incremental snapshots</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Remember to suspend access to the block device via the <code>fsfreeze</code> command before creating
a snapshot and to thaw the block device using <code>fsfreeze --unfreeze</code> once done.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Creating a snapshot is simple: <code>rbd snap create {pool_name/}{rbd_image}@{snap_name}</code></p>
</div>
<div class="paragraph">
<p>To manipulate the snapshots, the following command are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>rbd snap ls</code> - To list the snapshot of a RBD Image</p>
</li>
<li>
<p><code>rbd snap rollback</code> - To rollback a snapshot (restore)</p>
</li>
<li>
<p><code>rbd snap rm</code> - To delete a snapshot</p>
</li>
<li>
<p><code>rbd snap protect</code> - To protect s snapshot (used for cloning)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_clones"><a class="anchor" href="#_clones"></a>Clones</h3>
<div class="paragraph">
<p>RBD clones are read-write copies of an RBD image that use a protected RBD snapshot as a base. A
RBD clone can also be flattened, which converts it into an RBD image independent of its source.
The cloning process has three steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a snapshot</p>
</li>
<li>
<p>Protect the snapshot</p>
</li>
<li>
<p>Create a clone using the protected snapshot</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
By default Copy-On-Read (COR) is not enabled on RBD clones. This results in the data
potentially always being read from the parent RBD Image as long as the original RBD Image parent
has not been modified. The <code>rbd_clone_copy_on_read</code> is used to control COR.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
By default only Copy_On_Write (COW) is enabled and can not be disabled.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To manipulate RBD Clones the following commands are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>rbd children</code> - To list the clones of a RBD Image</p>
</li>
<li>
<p><code>rbd clone</code> - to create a clone</p>
</li>
<li>
<p><code>rbd flatten</code> - To flatten a clone</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A RBD clone, as it behaves like a regular RBD Image is deleted via the <code>rbd rm</code> command.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">
      <img src="../../_/img/header_logo.svg" alt="Ceph">
  </a>
</footer>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
