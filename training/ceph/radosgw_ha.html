<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Ceph Top Gun Enablement</title>
    <link rel="canonical" href="https://likid0.github.io/ceph-top-gun-enablement/training/ceph/radosgw_ha.html">
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">
          <img src="../../_/img/header_logo_reverse.svg" height="40px" alt="Red Hat Data Services">
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Get Help</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://access.redhat.com/documentation/en-us/red_hat_openshift_container_storage" target="_blank">OCS Documentation</a>
            <a class="navbar-item" href="https://bugzilla.redhat.com/describecomponents.cgi?product=Red%20Hat%20OpenShift%20Container%20Storage" target="_blank">Browse Bugs</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Improve Guides</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/red-hat-storage/ocs-training/blob/master/CONTRIBUTING.adoc" target="_blank">Guidelines</a>
            <a class="navbar-item" href="https://github.com/red-hat-storage/ocs-training/issues/new/choose" target="_blank">Open Issue</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Infos</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://www.redhat.com/en/blog/channel/red-hat-storage" target="_blank">Our Blog</a>
            <a class="navbar-item" href="https://www.youtube.com/channel/UCoyG8VyvB-XUxQl1mD3T3Gw" target="_blank">Youtube</a>
            <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">OCS Technology</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="training" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Ceph Top-Gun Enablement</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="opentlc_lab_env.html">Opentlc Lab Env</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph RadosGW</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_intro.html">RGW Introduction and Deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_arch_deep_dive.html">RGW Deep Dive</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="radosgw_ha.html">RGW High Availability</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_users_quotas.html">RGW Users &amp; Quotas</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_auth.html">RGW Auth &amp; Authz</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_object_versioning.html">RGW S3 Object Versioning</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_placement_and_storage_classes.html">RGW Placement &amp; Storage Classes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_life_cycle_management.html">RGW Life Cycle Management</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_bucket_policy.html">RGW S3 Bucket Policy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_sts_introduction.html">RGW Secure Token Service</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_sts_bucket_role_policy.html">RGW Bucket vs Role Policy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_multisite.html">RGW Multisite Replication</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Troubleshooting</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="trouble-shooting-nearfull-osds.html">Troubleshooting nearfull OSDs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="radosgw_multisite.html">RGW Multisite Replication</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ceph Stretched</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="rhcs-stretched-deploy.html">Ceph Stretch Mode</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Ceph Top-Gun Enablement</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Ceph Top-Gun Enablement</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Ceph Top-Gun Enablement</a></li>
    <li>Ceph RadosGW</li>
    <li><a href="radosgw_ha.html">RGW High Availability</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///antora/training/modules/ceph/pages/radosgw_ha.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<div class="sect1">
<h2 id="_providing_radosgw_ha"><a class="anchor" href="#_providing_radosgw_ha"></a>Providing RadosGW HA.</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h3>
<div class="paragraph">
<p>To avoid single points of failure in our Ceph RGW deployment we need to provide
an S3/RGW endpoint that can tolerate the failure of one or more RGW services.
RGW is a restfull HTTP endpoint, so it can be loadbalanced for HA and increased
performance in many ways. There are some great examples in this
<a href="https://github.com/mmgaggle/ceph-lb">repo</a></p>
</div>
<div class="paragraph">
<p>Since RHCS 5.1, Ceph provides a cephadm service called ingress that provides an
HA and loadbalancing stack based on keepalive and haproxy.</p>
</div>
<div class="paragraph">
<p>The ingress service allows you to create a high availability endpoint for RGW with a minimum set of configuration options. The orchestrator will deploy and manage a combination of haproxy and keepalived to provide load balancing on a floating virtual IP.
If SSL is used, then SSL must be configured and terminated by the ingress service and not RGW itself.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ingress.png" alt="HAproxy Ingress Service">
</div>
</div>
<div class="paragraph">
<p>There are N hosts where the ingress service is deployed. Each host has a haproxy daemon and a keepalived daemon. A virtual IP is automatically configured on only one of these hosts at a time.</p>
</div>
<div class="paragraph">
<p>Each keepalived daemon checks every few seconds whether the haproxy daemon on the same host is responding. Keepalived will also check that the master keepalived daemon is running without problems. If the “master” keepalived daemon or the active haproxy is not responding, one of the remaining keepalived daemons running in backup mode will be elected as master, and the virtual IP will be moved to that node.</p>
</div>
<div class="paragraph">
<p>The active haproxy acts like a load balancer, distributing all RGW requests between all the RGW daemons available.</p>
</div>
</div>
<div class="sect2">
<h3 id="_deploying_a_new_rgw_daemon"><a class="anchor" href="#_deploying_a_new_rgw_daemon"></a>Deploying a new RGW daemon</h3>
<div class="paragraph">
<p>Currently in our lab we have single RGW service/deamon running, we need at
least two RGW services configured with the same Real/Zonegroup/Zone and running
on different nodes, to be able to provide HA.</p>
</div>
<div class="paragraph">
<p>So we are going to increase the count of RGW daemons for service multi.zone1
that was previously created to 2, and we will deploy the new daemon on
ceph-node02, just as a reminder we can use the --dry-run parameter with cephadm
to see what actions will be taken:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[root@ceph-node01 ~]# ceph orch apply rgw multi.zone1 --realm=multisite --zone=zone1 --placement="2 proxy01 ceph-node02" --port=8000  --dry-run
####################
SERVICESPEC PREVIEWS
####################
+---------+-----------------+-------------+-------------+
|SERVICE  |NAME             |ADD_TO       |REMOVE_FROM  |
+---------+-----------------+-------------+-------------+
|rgw      |rgw.multi.zone1  |ceph-node02  |             |
+---------+-----------------+-------------+-------------+
################
OSDSPEC PREVIEWS
################
+---------+------+------+------+----+-----+
|SERVICE  |NAME  |HOST  |DATA  |DB  |WAL  |
+---------+------+------+------+----+-----+
+---------+------+------+------+----+-----+
[root@ceph-node01 ~]# ceph orch apply rgw multi.zone1 --realm=multisite --zone=zone1 --placement="2 proxy01 ceph-node02" --port=8000
Scheduled rgw.multi.zone1 update...
[root@ceph-node01 ~]# ceph orch ps | grep rgw
rgw.multi.zone1.ceph-node02.lviwfb  ceph-node02  *:8000       running (3m)      3m ago   3m    45.7M        -  16.2.8-85.el8cp  b2c997ff1898  0e3521f3a162
rgw.multi.zone1.proxy01.mhawfj      proxy01      *:8000       running (30m)     4m ago  30m    61.9M        -  16.2.8-85.el8cp  b2c997ff1898  4de70934f04e</pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have 2 rgw instances running we can deploy an ingress service to
provide HA and loadbalancing of out S3 http endpoint, we beed a VIP for
Keepalived to loadbalance, you can use <code>ip:</code> that has been pre-created and it has
a dns entry <code>s3zone1.example.com</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre># host s3zone1.example.com
s3zone1.example.com has address 192.168.56.100

# cat &lt;&lt; EOF &gt;  rgw-ingress.yaml
service_type: ingress
service_id: multi.zone1
placement:
  hosts:
    - ceph-node02
    - ceph-node03
spec:
  backend_service: rgw.multi.zone1
  virtual_ip: 192.168.56.100/24
  frontend_port: 80
  monitor_port:  1967
EOF

# ceph orch apply -i rgw-ingress.yaml --dry-run
####################
SERVICESPEC PREVIEWS
####################
+---------+-----------------------------+-------------------------+-------------+
|SERVICE  |NAME                         |ADD_TO                   |REMOVE_FROM  |
+---------+-----------------------------+-------------------------+-------------+
|ingress  |ingress.ingress.multi.zone1  |ceph-node02 ceph-node03  |             |
+---------+-----------------------------+-------------------------+-------------+
# ceph orch apply -i rgw-ingress.yaml
Scheduled ingress.ingress.multi.zone1 update...</pre>
</div>
</div>
<div class="paragraph">
<p>The services will take a while to get configured and running, we can check with
the ceph orch ps command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># ceph orch ps | grep ingress.multi
haproxy.ingress.multi.zone1.ceph-node02.vyqujm     ceph-node02  *:80,1967    running (23s)    14s ago   7m    6098k        -  2.2.19-7ea3822   6b6ff8a83cd7  f93e7a3ff94d
haproxy.ingress.multi.zone1.ceph-node03.omzjut     ceph-node03  *:80,1967    running (13s)     8s ago   7m    9537k        -  2.2.19-7ea3822   6b6ff8a83cd7  ce91e7ffc737
keepalived.ingress.multi.zone1.ceph-node02.yyelgh  ceph-node02               running (6m)     14s ago   6m    11.2M        -  2.1.5            f68c62a66d49  ab0d236e81eb
keepalived.ingress.multi.zone1.ceph-node03.btvglg  ceph-node03               running (6m)      8s ago   6m    16.7M        -  2.1.5            f68c62a66d49  5abb03a5f2bc</pre>
</div>
</div>
<div class="paragraph">
<p>We can curl the VIP to check that it&#8217;s working</p>
</div>
<div class="listingblock">
<div class="content">
<pre>curl http://s3zone1.example.com
&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;ListAllMyBucketsResult xmlns="http://s3.amazonaws.com/doc/2006-03-01/"&gt;&lt;Owner&gt;&lt;ID&gt;anonymous&lt;/ID&gt;&lt;DisplayName&gt;&lt;/DisplayName&gt;&lt;/Owner&gt;&lt;Buckets&gt;&lt;/Buckets&gt;&lt;/ListAllMyBucketsResult&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>The haproxy configuration can checked with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># cephadm enter --name haproxy.ingress.multi.zone1.ceph-node02.vyqujm cat /var/lib/haproxy/haproxy.cfg
...
frontend frontend
    bind 192.168.56.100:80
    default_backend backend

backend backend
    option forwardfor
    balance static-rr
    option httpchk HEAD / HTTP/1.0
    server rgw.multi.zone1.ceph-node02.lviwfb 192.168.56.62:8000 check weight 100
    server rgw.multi.zone1.proxy01.mhawfj 192.168.56.24:8000 check weight 100</pre>
</div>
</div>
<div class="paragraph">
<p>Keepalived config can also be checked with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># cephadm enter --name keepalived.ingress.multi.zone1.ceph-node02.yyelgh cat /etc/keepalived/keepalived.conf
...
vrrp_instance VI_0 {
  state MASTER
  priority 100
  interface eth0
  virtual_router_id 51
  advert_int 1
  authentication {
      auth_type PASS
      auth_pass ythfkjlbyqokmslqmuwx
  }
  unicast_src_ip 192.168.56.62
  unicast_peer {
    192.168.56.63
  }
  virtual_ipaddress {
    192.168.56.100/24 dev eth0
  }
...</pre>
</div>
</div>
<div class="paragraph">
<p>NOTICE: One thing to take into account with Ingress service and keepalived is that it
uses the vrrp protocol, so vrrp comunications need to be allowed in the
network.</p>
</div>
<div class="paragraph">
<p>Now that we have the Ingress service working, and the Client requests are being
loadbalanced between both RGW services, you can shutodown a node, and check
with and s3client that you can still interact with the S3 endpoint, uploading
some files for example.</p>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">
      <img src="../../_/img/header_logo.svg" alt="Red Hat Data Services">
  </a>
</footer>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
